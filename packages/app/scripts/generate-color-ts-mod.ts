/// <reference types="node" />

import * as fs from "fs/promises";
import * as path from "path";
import { fileURLToPath } from "url";

import { formatHex, formatHex8, parse } from "culori";

type generate_color_json_Color = {
	oklch: string;
	hex: string;
};

function generate_color_json_get_paths() {
	const scriptFilePath = fileURLToPath(import.meta.url);
	const scriptDir = path.dirname(scriptFilePath);

	const appRootDir = path.resolve(scriptDir, "..");
	const inputCssPath = path.resolve(appRootDir, "src", "app.css");
	const outputTsPath = path.resolve(appRootDir, "src", "assets", "ts", "app-colors-css-vars.ts");

	return {
		appRootDir,
		inputCssPath,
		outputTsPath,
	};
}

function generate_color_json_extract_oklch_vars(css: string) {
	const results: Array<{ name: string; oklch: string }> = [];

	// Extract ONLY variables like:
	// --color-foo-bar: oklch(...);
	//
	// Note: we intentionally keep the source `oklch(...)` string, since that's what you want in JSON.
	const regex = /--(color-[a-zA-Z0-9-_]+)\s*:\s*(oklch\([^;]+\))\s*;/g;
	for (const match of css.matchAll(regex)) {
		const name = match[1]?.trim();
		const oklch = match[2]?.trim();
		if (!name || !oklch) {
			continue;
		}
		results.push({ name, oklch });
	}

	return results;
}

function generate_color_json_oklch_to_hex(oklch: string) {
	const parsed = parse(oklch);
	if (!parsed) {
		return null;
	}

	const alpha = typeof parsed.alpha === "number" ? parsed.alpha : 1;
	return alpha < 1 ? formatHex8(parsed) : formatHex(parsed);
}

async function generate_color_json_main() {
	const { inputCssPath, outputTsPath } = generate_color_json_get_paths();

	const css = await fs.readFile(inputCssPath, "utf8");
	const vars = generate_color_json_extract_oklch_vars(css);

	const out: Record<string, generate_color_json_Color> = {};
	const duplicates = new Set<string>();

	for (const item of vars) {
		if (Object.prototype.hasOwnProperty.call(out, item.name)) {
			duplicates.add(item.name);
		}

		const hex = generate_color_json_oklch_to_hex(item.oklch);
		if (!hex) {
			throw new Error(`culori failed to parse: ${item.oklch} (from --${item.name})`);
		}

		out[item.name] = {
			oklch: item.oklch,
			hex: hex.toLowerCase(),
		};
	}

	// Stable output ordering
	const ordered: Record<string, generate_color_json_Color> = {};
	for (const key of Object.keys(out).sort()) {
		ordered[key] = out[key];
	}

	const header = [
		"// This file is generated by `scripts/generate-color-ts-mod.ts`.",
		"// Do not edit by hand; run the script to regenerate from `src/app.css`.",
		"",
	].join("\n");

	const contents = `${header}export const app_colors_css_vars = ${JSON.stringify(ordered, null, "\t")} as const;\n`;

	await fs.mkdir(path.dirname(outputTsPath), { recursive: true });
	await fs.writeFile(outputTsPath, contents, "utf8");

	console.info(
		`Wrote ${Object.keys(ordered).length} colors to ${outputTsPath}${
			duplicates.size ? ` (duplicates overwritten: ${Array.from(duplicates).join(", ")})` : ""
		}`,
	);
}

await generate_color_json_main();
